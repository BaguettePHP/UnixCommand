#!/usr/bin/env php
<?php
namespace zonuexe\UnixCommand;

/**
 * CAT command
 *
 * @author    USAMI KENTA <tadsan@zonu.me>
 * @license   http://www.apache.org/licenses/LICENSE-2.0 Apache-2.0
 * @copyright 2015 USAMI Kenta
 */

if (realpath($_SERVER['SCRIPT_FILENAME']) == realpath(__FILE__)) {
    $argv = isset($_SERVER['argv']) ? $_SERVER['argv'] : [];
    array_shift($argv);

    exit(cat($argv));
}

/**
 * @return int UNIX status code
 */
function cat(array $argv)
{
    $files  = $argv ?: ['-'];
    $failed = false;
    $stdin  = null;

    foreach ($files as $f) {
        $file = null;
        if ($f === '-') {
            if ($stdin !== null) {
                echo $stdin;
                continue;
            }

            $file = STDIN;
        } elseif (!is_file($f)) {
            $failed = true;
            fwrite(STDERR, "cat: ${f}: No such file or directory" . PHP_EOL);
            continue;
        } else {
            $file = fopen($f, 'r');
        }

        while (!feof($file)) {
            $data = fread($file, 8192);
            if ($data === false) {
                break;
            }
            if ($f === '-') {
                $stdin .= $data;
            }

            echo $data;
        }
        fclose($file);
    }

    return $failed ? 1 : 0;
}
